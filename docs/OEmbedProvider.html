<!DOCTYPE html>

<html>
<head>
  <title>OEmbedProvider.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="EmbedEngine.html">
                  EmbedEngine.js
                </a>
              
                
                <a class="source" href="OEmbedProvider.html">
                  OEmbedProvider.js
                </a>
              
                
                <a class="source" href="URLEmbedProvider.html">
                  URLEmbedProvider.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>OEmbedProvider.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">let</span> querystring = <span class="hljs-built_in">require</span>(<span class="hljs-string">'querystring'</span>);
<span class="hljs-keyword">let</span> request = <span class="hljs-built_in">require</span>(<span class="hljs-string">'request'</span>);
<span class="hljs-keyword">let</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>);

<span class="hljs-keyword">let</span> URLEmbedProvider = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./URLEmbedProvider'</span>);

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OEmbedProvider</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">URLEmbedProvider</span> </span>{
  <span class="hljs-keyword">constructor</span> (providerURL, urlPatterns, format) {
    <span class="hljs-keyword">super</span>(urlPatterns);
    <span class="hljs-keyword">if</span> (providerURL) <span class="hljs-keyword">this</span>.providerURL = providerURL;
    <span class="hljs-keyword">if</span> (format) <span class="hljs-keyword">this</span>.format = format;
  }

  getEmbed (options, callback) {
    <span class="hljs-keyword">if</span> (!options || !options.embedURL) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Options object missing required property: embedURL'</span>);
    }

    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;

    <span class="hljs-keyword">this</span>.makeAPIRequest(options, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, data</span>) </span>{
      <span class="hljs-keyword">if</span> (error) {
        callback(error, data);
      } <span class="hljs-keyword">else</span> {
        self.filterData(data, options);
        callback(<span class="hljs-literal">null</span>, data);
      }
    });
  }

  makeAPIRequest (options, callback) {
    <span class="hljs-keyword">let</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">let</span> requestOptions = self.getRequestOptions(options);
    <span class="hljs-keyword">let</span> oembedAPIURL = self.getAPIURL(options, requestOptions);
    <span class="hljs-keyword">let</span> data;
    requestOptions.url = oembedAPIURL;

    self.request(requestOptions, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error, response, body</span>) </span>{
      <span class="hljs-keyword">if</span> (!error &amp;&amp; response.statusCode === <span class="hljs-number">200</span>) {
        <span class="hljs-keyword">try</span> {
          <span class="hljs-keyword">if</span> (self.format === <span class="hljs-string">'json'</span>) {
            body = self.convertHighBitUnicodeToSurrogates(body);
            data = <span class="hljs-built_in">JSON</span>.parse(body);
            data.options = options;
            data.oembedAPIURL = response.request.uri.href;
            callback(<span class="hljs-literal">null</span>, data);
          }
        } <span class="hljs-keyword">catch</span> (error) {
          <span class="hljs-keyword">let</span> data = {
            html: self.errorMarkup(options, error),
            options: options
          };
          callback(error, data);
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">if</span> (error) {
          data = {
            html: self.errorMarkup(options, error),
            options: options
          };
          callback(error, data);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-keyword">let</span> errorMarkupFunctionName = <span class="hljs-string">'errorMarkup'</span> + response.statusCode;
          <span class="hljs-keyword">let</span> errorMarkupFunction = self[errorMarkupFunctionName] ? self[errorMarkupFunctionName] : self.errorMarkup;
          data = {
            html: errorMarkupFunction(options, error),
            options: options
          };
          callback(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'HTTP status '</span> + response.statusCode + <span class="hljs-string">' for embed provider URL: '</span> + oembedAPIURL), data);
        }
      }
    });
  }

  getAPIURL (options, requestOptions) {
    <span class="hljs-keyword">let</span> qs = {};
    qs.url = options.embedURL;
    qs.format = <span class="hljs-keyword">this</span>.format;
    <span class="hljs-keyword">if</span> (options.maxWidth) qs.maxwidth = options.maxWidth;
    <span class="hljs-keyword">if</span> (options.maxHeight) qs.maxheight = options.maxHeight;

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.defaultProviderQueryStringParameters) {
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> name <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>.defaultProviderQueryStringParameters) {
        qs[name] = <span class="hljs-keyword">this</span>.defaultProviderQueryStringParameters[name];
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.providerURL + <span class="hljs-string">'?'</span> + querystring.stringify(qs);
  }

  getRequestOptions (options) {
    <span class="hljs-keyword">let</span> fileContents = fs.readFileSync(__dirname + <span class="hljs-string">'/../../package.json'</span>);
    <span class="hljs-keyword">let</span> packageJSON = <span class="hljs-built_in">JSON</span>.parse(fileContents);
    <span class="hljs-keyword">let</span> requestOptions = {
      headers: {
        <span class="hljs-string">'User-Agent'</span>: <span class="hljs-string">'URLEmbed Module HTTP Agent '</span> + packageJSON.version
      },
      timeout: <span class="hljs-keyword">this</span>.timeoutMs
    };
    <span class="hljs-keyword">return</span> requestOptions;
  }

  <span class="hljs-comment">/*
    Note: JSON.parse yields a parse error when it encounters unicode literals &gt; 16-bits.
    Notably, many newer emojis fall into this category.

    To solve for this you need to split the &gt; 16-bit unicode escapedcode point into surrogate pairs.

    Great and entertaining explaination here:
    https://gist.github.com/mranney/1707371

    Algorithm for calculating surrogate pairs cribbed from here:
    http://www.russellcottrell.com/greek/utilities/surrogatepaircalculator.htm
  */</span>
  convertHighBitUnicodeToSurrogates (body) {
    <span class="hljs-keyword">return</span> body.replace(<span class="hljs-regexp">/\\U([\da-f]{8})/gm</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">match, scalarVal</span>) </span>{
      <span class="hljs-keyword">let</span> S = <span class="hljs-built_in">parseInt</span>(<span class="hljs-string">'0x'</span> + scalarVal, <span class="hljs-number">16</span>);
      <span class="hljs-keyword">let</span> H = <span class="hljs-built_in">Math</span>.floor((S - <span class="hljs-number">0x10000</span>) / <span class="hljs-number">0x400</span>) + <span class="hljs-number">0xD800</span>;
      <span class="hljs-keyword">let</span> L = ((S - <span class="hljs-number">0x10000</span>) % <span class="hljs-number">0x400</span>) + <span class="hljs-number">0xDC00</span>;
      <span class="hljs-keyword">return</span> <span class="hljs-string">'\\u'</span> + H.toString(<span class="hljs-number">16</span>) + <span class="hljs-string">'\\u'</span> + L.toString(<span class="hljs-number">16</span>);
    });
  }</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Stub method caled by EmbedEngine</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  configure (configOptions) {
    <span class="hljs-keyword">if</span> (configOptions.timeoutMs) {
      <span class="hljs-keyword">this</span>.timeoutMs = configOptions.timeoutMs;
    }
  }
}</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Default to JSON format</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>OEmbedProvider.prototype.format = <span class="hljs-string">'json'</span>;
OEmbedProvider.prototype.timeoutMs = <span class="hljs-number">2000</span>;
OEmbedProvider.prototype.request = request;
OEmbedProvider.prototype.defaultProviderQueryStringParameters = <span class="hljs-literal">null</span>;

<span class="hljs-built_in">module</span>.exports = OEmbedProvider;</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
