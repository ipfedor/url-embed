<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/OEmbedProvider.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/mkopit/url-embed.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  </ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/OEmbedProvider.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

let querystring = require(&apos;querystring&apos;);
let request = require(&apos;request&apos;);
let fs = require(&apos;fs&apos;);

let URLEmbedProvider = require(&apos;./URLEmbedProvider&apos;);

class OEmbedProvider extends URLEmbedProvider {
  constructor (providerURL, urlPatterns, format) {
    super(urlPatterns);
    if (providerURL) this.providerURL = providerURL;
    if (format) this.format = format;
  }

  getEmbed (options, callback) {
    if (!options || !options.embedURL) {
      throw new Error(&apos;Options object missing required property: embedURL&apos;);
    }

    let self = this;

    this.makeAPIRequest(options, function (error, data) {
      if (error) {
        callback(error, data);
      } else {
        self.filterData(data, options);
        callback(null, data);
      }
    });
  }

  makeAPIRequest (options, callback) {
    let self = this;
    let requestOptions = self.getRequestOptions(options);
    let oembedAPIURL = self.getAPIURL(options, requestOptions);
    let data;
    requestOptions.url = oembedAPIURL;

    self.request(requestOptions, function (error, response, body) {
      if (!error &amp;&amp; response.statusCode === 200) {
        try {
          if (self.format === &apos;json&apos;) {
            body = self.convertHighBitUnicodeToSurrogates(body);
            data = JSON.parse(body);
            data.options = options;
            data.oembedAPIURL = response.request.uri.href;
            callback(null, data);
          }
        } catch (error) {
          let data = {
            html: self.errorMarkup(options, error),
            options: options
          };
          callback(error, data);
        }
      } else {
        if (error) {
          data = {
            html: self.errorMarkup(options, error),
            options: options
          };
          callback(error, data);
        } else {
          let errorMarkupFunctionName = &apos;errorMarkup&apos; + response.statusCode;
          let errorMarkupFunction = self[errorMarkupFunctionName] ? self[errorMarkupFunctionName] : self.errorMarkup;
          data = {
            html: errorMarkupFunction(options, error),
            options: options
          };
          callback(new Error(&apos;HTTP status &apos; + response.statusCode + &apos; for embed provider URL: &apos; + oembedAPIURL), data);
        }
      }
    });
  }

  getAPIURL (options, requestOptions) {
    let qs = {};
    qs.url = options.embedURL;
    qs.format = this.format;
    if (options.maxWidth) qs.maxwidth = options.maxWidth;
    if (options.maxHeight) qs.maxheight = options.maxHeight;

    if (this.defaultProviderQueryStringParameters) {
      for (let name in this.defaultProviderQueryStringParameters) {
        qs[name] = this.defaultProviderQueryStringParameters[name];
      }
    }

    return this.providerURL + &apos;?&apos; + querystring.stringify(qs);
  }

  getRequestOptions (options) {
    let fileContents = fs.readFileSync(__dirname + &apos;/../../package.json&apos;);
    let packageJSON = JSON.parse(fileContents);
    let requestOptions = {
      headers: {
        &apos;User-Agent&apos;: &apos;URLEmbed Module HTTP Agent &apos; + packageJSON.version
      },
      timeout: this.timeoutMs
    };
    return requestOptions;
  }

  /*
    Note: JSON.parse yields a parse error when it encounters unicode literals &gt; 16-bits.
    Notably, many newer emojis fall into this category.

    To solve for this you need to split the &gt; 16-bit unicode escapedcode point into surrogate pairs.

    Great and entertaining explaination here:
    https://gist.github.com/mranney/1707371

    Algorithm for calculating surrogate pairs cribbed from here:
    http://www.russellcottrell.com/greek/utilities/surrogatepaircalculator.htm
  */
  convertHighBitUnicodeToSurrogates (body) {
    return body.replace(/\\U([\da-f]{8})/gm, function (match, scalarVal) {
      let S = parseInt(&apos;0x&apos; + scalarVal, 16);
      let H = Math.floor((S - 0x10000) / 0x400) + 0xD800;
      let L = ((S - 0x10000) % 0x400) + 0xDC00;
      return &apos;\\u&apos; + H.toString(16) + &apos;\\u&apos; + L.toString(16);
    });
  }

  // Stub method caled by EmbedEngine
  configure (configOptions) {
    if (configOptions.timeoutMs) {
      this.timeoutMs = configOptions.timeoutMs;
    }
  }
}

// Default to JSON format
OEmbedProvider.prototype.format = &apos;json&apos;;
OEmbedProvider.prototype.timeoutMs = 2000;
OEmbedProvider.prototype.request = request;
OEmbedProvider.prototype.defaultProviderQueryStringParameters = null;

module.exports = OEmbedProvider;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.5)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
