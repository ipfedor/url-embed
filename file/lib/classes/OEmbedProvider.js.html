<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">lib/classes/OEmbedProvider.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/mkopit/url-embed.git" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">classes</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/Embed.js~Embed.html">Embed</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/EmbedEngine.js~EmbedEngine.html">EmbedEngine</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/lib/classes/OEmbedProvider.js~OEmbedProvider.html">OEmbedProvider</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-interface">I</span><span data-ice="name"><span><a href="class/lib/classes/URLEmbedProvider.js~URLEmbedProvider.html">URLEmbedProvider</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">classes/default_providers</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/DailyMotion.js~DailyMotion.html">DailyMotion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/FacebookPosts.js~FacebookPosts.html">FacebookPosts</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/FacebookVideo.js~FacebookVideo.html">FacebookVideo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/Flickr.js~Flickr.html">Flickr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/Imgur.js~Imgur.html">Imgur</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/Instagram.js~Instagram.html">Instagram</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/Soundcloud.js~SoundCloud.html">SoundCloud</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/Spotify.js~Spotify.html">Spotify</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/Tumblr.js~Tumblr.html">Tumblr</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/Twitter.js~Twitter.html">Twitter</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/Videopress.js~Videopress.html">Videopress</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/Vimeo.js~Vimeo.html">Vimeo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/default_providers/Youtube.js~Youtube.html">Youtube</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">classes/errors</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/errors/EmbedValidationError.js~EmbedValidationError.html">EmbedValidationError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/errors/UnexpectedStatusError.js~UnexpectedStatusError.html">UnexpectedStatusError</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/lib/classes/errors/UnknownProviderError.js~UnknownProviderError.html">UnknownProviderError</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">lib/classes/OEmbedProvider.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;;

/** @ignore */
let querystring = require(&apos;querystring&apos;);

/** @ignore */
let request = require(&apos;request&apos;);

/** @ignore */
let fs = require(&apos;fs&apos;);

/** @ignore */
let UnexpectedStatusError = require(&apos;./errors/UnexpectedStatusError&apos;);

/** @ignore */
let URLEmbedProvider = require(&apos;./URLEmbedProvider&apos;);

/** @ignore */
let xml2js = require(&apos;xml2js&apos;);

/**
* Converts a pattern of URLs into markup via an oembed provider
* @see http://oembed.com
* @extends {URLEmbedProvider}
* @interface
*/
class OEmbedProvider extends URLEmbedProvider {

  /**
  * @param {String} providerURL - the URL of the provider&apos;s oembed service
  * @param {Array&lt;RegExp&gt;} urlPatterns - array of regular expressions that this provider will match
  * @param {String} format - the data format of the provider&apos;s oembed service. Must be either &apos;json&apos; or &apos;xml&apos;.
  */
  constructor (providerURL, urlPatterns, format) {
    super(urlPatterns);

    /**
    * The URL of the provider&apos;s oembed service
    * @type {String}
    */
    if (providerURL) this.providerURL = providerURL;

    /**
    * @desc The data format of the provider&apos;s oembed service.
    * @type {String}
    */
    if (format) this.format = format;

    /**
    * The version number of the url-embed module
    * @type {String}
    */
    this.version = null;
  }

  /**
  * Resolves options.embedURL to an embed and passes it to callback.
  * @param {Embed} embed - Embed object
  * @param {function(embed:Embed)} callback - callback to invoke after resolving embed
  * @throws {UnexpectedStatusError} throws when provider API returns a non-200 response.
  * @override
  */
  getEmbed (embed, callback) {
    this.makeAPIRequest(embed, function (embed) {
      callback(embed);
    });
  }

  /**
  * Makes the requests to the oembed provider&apos;s API
  * @param {Embed} embed - embed object
  * @param {function(embed:Ebmed)} callback - callback to invoke after resolving embed
  */
  makeAPIRequest (embed, callback) {
    let self = this;
    let requestOptions = self.buildRequestOptions(embed);
    let oembedAPIURL = self.buildAPIURL(embed, requestOptions);
    requestOptions.url = oembedAPIURL;

    self.request(requestOptions, function (error, response, body) {
      if (response &amp;&amp; response.request &amp;&amp; response.request.uri &amp;&amp; response.request.uri.href) {
        embed.oembedAPIURL = response.request.uri.href;
      } else {
        embed.oembedAPIURL = oembedAPIURL;
      }

      if (!error &amp;&amp; response.statusCode === 200) {
        self.parseResponseBody(body, function (error, data) {
          // json or xml parsing error
          if (error) {
            self._applyErrorToEmbed(error, embed);
            callback(embed);
            return;
          // successfuly parsed
          } else {
            embed.data = data;
            self.filterData(embed.data);
            callback(embed);
            return;
          }
        });
      } else {
        // Error making request
        if (error) {
          self._applyErrorToEmbed(error, embed);
          callback(embed);
          return;
        // No error, but non-200 HTTP response
        } else {
          let errorMarkupFunctionName = &apos;errorMarkup&apos; + response.statusCode;
          let errorMarkupFunction = self[errorMarkupFunctionName] ? self[errorMarkupFunctionName] : self.errorMarkup;
          let error = new UnexpectedStatusError(&apos;HTTP status &apos; + response.statusCode + &apos; for embed provider URL: &apos; + oembedAPIURL);
          error.status = response.statusCode;
          self._applyErrorToEmbed(error, embed, errorMarkupFunction);
          callback(embed);
          return;
        }
      }
    });
  }

  /**
  * Puts the Embed into an error state if an error occurs
  * @param {Error} error - the Error that occurred
  * @param {Embed} embed - the Embed object
  * @param {function(embed: Embed, error: Error)} [errorMarkupFunction] - function that generates error markup
  */
  _applyErrorToEmbed (error, embed, errorMarkupFunction) {
    if (!errorMarkupFunction) {
      errorMarkupFunction = this.errorMarkup;
    }
    embed.data.html = errorMarkupFunction(embed, error);
    embed.error = error;
  }

  /**
  * Parses the provider API response into a data object
  * @param {String} body - API response
  * @param {function(error: Error, data: Object)} callback - callback to invoke with resulting oembed data
  */
  parseResponseBody (body, callback) {
    body = this.convertHighBitUnicodeToSurrogates(body);
    let data;
    if (this.format === &apos;json&apos;) {
      try {
        data = JSON.parse(body);
        callback(null, data);
      } catch (error) {
        callback(error);
      }
      return;
    } else {
      let xmlOptions = {
        explicitArray: false,
        valueProcessors: [
          xml2js.processors.parseNumbers,
          xml2js.processors.parseBooleans
        ]
      };
      data = xml2js.parseString(body, xmlOptions, function (error, result) {
        if (error) {
          callback(error);
        } else {
          data = result.oembed;
          callback(null, data);
        }
        return;
      });
    }
  }

  /**
  * Builds the API URL string
  * @param {Embed} embed - Embed object
  * @return {String} - API URL
  */
  buildAPIURL (embed) {
    let qs = {};
    qs.url = embed.embedURL;
    qs.format = this.format;
    if (embed.options.maxWidth) qs.maxwidth = embed.options.maxWidth;
    if (embed.options.maxHeight) qs.maxheight = embed.options.maxHeight;

    if (this.defaultProviderQueryStringParameters) {
      for (let name in this.defaultProviderQueryStringParameters) {
        qs[name] = this.defaultProviderQueryStringParameters[name];
      }
    }

    return this.providerURL + &apos;?&apos; + querystring.stringify(qs);
  }

  /**
  * Builds the HTTP request options (headers, etc.)
  * @see https://www.npmjs.com/package/request
  * @param {Embed} embed - Embed object
  * @return {Object} - request options
  */
  buildRequestOptions (embed) {
    if (!this.version) {
      let fileContents = fs.readFileSync(__dirname + &apos;/../../package.json&apos;);
      let packageJSON = JSON.parse(fileContents);
      this.version = packageJSON.version;
    }

    let requestOptions = {
      headers: {
        &apos;User-Agent&apos;: &apos;URLEmbed Module HTTP Agent &apos; + this.version
      },
      timeout: this.timeoutMs
    };
    return requestOptions;
  }

  /**
  * Converts high-bit-value escaped unicode code points to unicode surrogate pair code points.
  *
  * JSON.parse yields a parse error when it encounters unicode literals &gt; 16-bits.
  * Notably, many newer emojis fall into this category.
  *
  * To solve for this you need to split the &gt; 16-bit unicode escapedcode point into surrogate pairs.
  *
  * Great and entertaining explaination here:
  * {@link https://gist.github.com/mranney/1707371}
  *
  * Algorithm for calculating surrogate pairs cribbed from here:
  * {@link http://www.russellcottrell.com/greek/utilities/surrogatepaircalculator.htm}
  *
  * @param {String} body - The raw body of the HTTP response from the oembed provider&apos;s API
  * @return {String} - The transformed body with surrogate pairs
  */
  convertHighBitUnicodeToSurrogates (body) {
    return body.replace(/\\U([\da-f]{8})/gm, function (match, scalarVal) {
      let S = parseInt(&apos;0x&apos; + scalarVal, 16);
      let H = Math.floor((S - 0x10000) / 0x400) + 0xD800;
      let L = ((S - 0x10000) % 0x400) + 0xDC00;
      return &apos;\\u&apos; + H.toString(16) + &apos;\\u&apos; + L.toString(16);
    });
  }

  /**
  * Configures the provider
  * @param {Object} configOptions
  * @param {number} configOptions.timeoutMs - Request timeout in milliseconds.
  * @override
  */
  configure (configOptions) {
    if (configOptions &amp;&amp; configOptions.timeoutMs) {
      this.timeoutMs = configOptions.timeoutMs;
    }
  }
}

/**
* The data format of the provider&apos;s oembed service. Defaults to &apos;json&apos;
* @identifier format
* @type {String}
*/
OEmbedProvider.prototype.format = &apos;json&apos;;

/**
* Default request timeout in milliseconds. Defaults to 2000.
* @type {number}
* @identifier timeoutMs
*/
OEmbedProvider.prototype.timeoutMs = 2000;

/**
* Reference to the request module.
* @type {Object}
* @see https://www.npmjs.com/package/request
*/
OEmbedProvider.prototype.request = request;

/**
* Object containing any any odd querystring parameters that the provider&apos;s oembed service requires.
* @type {Object}
*/
OEmbedProvider.prototype.defaultProviderQueryStringParameters = null;

module.exports = OEmbedProvider;
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.5)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
